name: Build and Deploy to Cloud Run
on:
    push:
        branches:
            - main

env:
    REGION: us-central1
    SERVICE_NAME: go-api

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Validate secrets
              run: |
                  PROJECT_ID="${{ secrets.GCP_PROJECT_ID }}"
                  PROVIDER="${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}"
                  SERVICE_ACCOUNT="${{ secrets.GCP_SERVICE_ACCOUNT }}"

                  if [ -z "$PROJECT_ID" ]; then
                      echo "Error: GCP_PROJECT_ID secret is not set"
                      exit 1
                  fi
                  if [ -z "$PROVIDER" ]; then
                      echo "Error: GCP_WORKLOAD_IDENTITY_PROVIDER secret is not set"
                      exit 1
                  fi
                  if [ -z "$SERVICE_ACCOUNT" ]; then
                      echo "Error: GCP_SERVICE_ACCOUNT secret is not set"
                      exit 1
                  fi
                  echo "âœ“ All required secrets are configured"

            - name: Authenticate to GCP (OIDC)
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
                  service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

            - name: Setup gcloud SDK
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ secrets.GCP_PROJECT_ID }}

            - name: Build and push image to Container Registry
              run: |
                  IMAGE="gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
                  gcloud builds submit --tag "${IMAGE}"

            - name: Deploy to Cloud Run
              uses: google-github-actions/deploy-cloudrun@v1
              with:
                  service: ${{ env.SERVICE_NAME }}
                  image: gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
                  region: ${{ env.REGION }}
                  allow-unauthenticated: true
